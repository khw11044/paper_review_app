{% extends "base.html" %}

{% block title %}논문 읽기 - LLM Paper Review for Arobot{% endblock %}

{% block extra_css %}
<style>
    .paper-container {
        height: calc(100vh - 4rem);
    }
    .drop-zone {
        border: 2px dashed #ccc;
        border-radius: 0.5rem;
        transition: all 0.3s ease;
    }
    .drop-zone:hover, .drop-zone.dragover {
        border-color: #4f46e5;
        background-color: rgba(79, 70, 229, 0.05);
    }
    .loading-overlay {
        background: rgba(255, 255, 255, 0.9);
    }
    .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: #4f46e5;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="flex flex-col md:flex-row paper-container">
    <!-- 왼쪽 패널 - 원본 논문 -->
    <div class="w-full md:w-1/2 border-r border-gray-200 flex flex-col">
        <div class="p-4 bg-white border-b border-gray-200 flex justify-between items-center">
            <h2 class="text-lg font-semibold text-gray-800">원본 논문</h2>
            {% if not paper %}
            <span class="text-sm text-gray-500">PDF 파일을 업로드하세요</span>
            {% endif %}
        </div>
        
        <div class="flex-1 overflow-y-auto p-4 relative">
            {% if not paper %}
            <!-- PDF 업로드 영역 -->
            <div id="drop-zone" class="drop-zone h-full flex flex-col items-center justify-center p-6">
                <i class="fas fa-file-pdf text-4xl text-gray-400 mb-4"></i>
                <p class="text-center text-gray-500 mb-2">PDF 파일을 여기에 드래그하거나</p>
                <label for="pdf-upload" class="cursor-pointer bg-indigo-600 text-white py-2 px-4 rounded shadow-sm hover:bg-indigo-700 transition">
                    파일 선택
                </label>
                <input id="pdf-upload" type="file" accept=".pdf" class="hidden">
            </div>
            
            <!-- 로딩 오버레이 (처음에는 숨김) -->
            <div id="loading-overlay" class="loading-overlay absolute inset-0 flex flex-col items-center justify-center hidden">
                <div class="spinner mb-4"></div>
                <p class="text-gray-700 font-medium">논문 분석 중...</p>
                <p class="text-gray-500 text-sm mt-2">잠시만 기다려주세요</p>
            </div>
            {% else %}
            <!-- 저장된 논문 콘텐츠 표시 -->
            <div class="markdown-body">
                {{ paper.original_content | safe }}
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- 오른쪽 패널 - 번역/요약/참조 -->
    <div class="w-full md:w-1/2 flex flex-col">
        <!-- 탭 메뉴 -->
        <div class="bg-white border-b border-gray-200">
            <div class="flex">
                <button class="tab-button px-4 py-3 font-medium text-sm focus:outline-none border-b-2 border-indigo-600 text-indigo-600" data-tab="translation">번역</button>
                <button class="tab-button px-4 py-3 font-medium text-sm focus:outline-none border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="summary">요약</button>
                <button class="tab-button px-4 py-3 font-medium text-sm focus:outline-none border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="references">참조</button>
            </div>
        </div>
        
        <!-- 탭 콘텐츠 -->
        <div class="flex-1 overflow-y-auto relative">
            <!-- 번역 탭 -->
            <div id="translation-tab" class="tab-content active p-4">
                {% if paper and paper.translation %}
                <div class="markdown-body">
                    {{ paper.translation | safe }}
                </div>
                {% else %}
                <div class="h-full flex items-center justify-center text-gray-500">
                    <p>PDF 파일을 업로드하면 번역 결과가 여기에 표시됩니다.</p>
                </div>
                {% endif %}
            </div>
            
            <!-- 요약 탭 -->
            <div id="summary-tab" class="tab-content p-4">
                {% if paper and paper.summary %}
                <div class="markdown-body">
                    {{ paper.summary | safe }}
                </div>
                {% else %}
                <div class="h-full flex items-center justify-center text-gray-500">
                    <p>PDF 파일을 업로드하면 요약 결과가 여기에 표시됩니다.</p>
                </div>
                {% endif %}
            </div>
            
            <!-- 참조 탭 -->
            <div id="references-tab" class="tab-content p-4">
                {% if paper and paper.references %}
                <div class="markdown-body">
                    {{ paper.references | safe }}
                </div>
                {% else %}
                <div class="h-full flex items-center justify-center text-gray-500">
                    <p>PDF 파일을 업로드하면 참조 분석 결과가 여기에 표시됩니다.</p>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- 저장 버튼 (분석 결과가 있을 때만 표시) -->
        <div id="save-button-container" class="p-4 bg-gray-50 border-t border-gray-200 {% if not paper or not paper.translation %}hidden{% endif %}">
            <button id="save-button" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition flex items-center justify-center">
                <i class="fas fa-save mr-2"></i> 저장하기
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 탭 전환 기능
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                // 활성 탭 버튼 스타일 변경
                tabButtons.forEach(btn => {
                    btn.classList.remove('border-indigo-600', 'text-indigo-600');
                    btn.classList.add('border-transparent', 'text-gray-500');
                });
                button.classList.remove('border-transparent', 'text-gray-500');
                button.classList.add('border-indigo-600', 'text-indigo-600');
                
                // 탭 콘텐츠 전환
                const tabId = button.getAttribute('data-tab');
                tabContents.forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabId}-tab`).classList.add('active');
            });
        });
        
        // PDF 파일 업로드 처리
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('pdf-upload');
        const loadingOverlay = document.getElementById('loading-overlay');
        
        if (dropZone && fileInput) {
            // 드래그 앤 드롭 이벤트
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                dropZone.classList.add('dragover');
            }
            
            function unhighlight() {
                dropZone.classList.remove('dragover');
            }
            
            // 파일 드롭 처리
            dropZone.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length) {
                    handleFiles(files);
                }
            }
            
            // 파일 선택 처리
            fileInput.addEventListener('change', function() {
                if (fileInput.files.length) {
                    handleFiles(fileInput.files);
                }
            });
            
            function handleFiles(files) {
                const file = files[0];
                
                if (file.type !== 'application/pdf') {
                    alert('PDF 파일만 업로드할 수 있습니다.');
                    return;
                }
                
                // 로딩 오버레이 표시
                loadingOverlay.classList.remove('hidden');
                
                // FormData 생성
                const formData = new FormData();
                formData.append('file', file);
                formData.append('title', file.name.replace('.pdf', ''));
                
                // 서버에 업로드
                fetch('/paper/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // 여기에서 LangChain 분석을 시작하는 요청을 할 수 있습니다.
                        // 임시로 3초 후에 분석 완료됐다고 가정
                        setTimeout(() => {
                            // 분석 완료 후 결과를 표시
                            loadingOverlay.classList.add('hidden');
                            showAnalysisResults(data.paper_id);
                        }, 3000);
                    } else {
                        loadingOverlay.classList.add('hidden');
                        alert('파일 업로드에 실패했습니다.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    loadingOverlay.classList.add('hidden');
                    alert('파일 업로드 중 오류가 발생했습니다.');
                });
            }
        }
        
        // 분석 결과 표시 (실제로는 서버에서 받아온 데이터로 채워야 함)
        function showAnalysisResults(paperId) {
            // 이 부분은 LangChain 통합 후 실제 데이터로 구현해야 합니다
            // 임시 데이터로 결과 표시
            const originalContent = document.querySelector('.markdown-body');
            if (originalContent) {
                originalContent.innerHTML = '<h1>Sample Paper Title</h1><p>This is a sample paper content...</p>';
            }
            
            document.getElementById('translation-tab').innerHTML = '<div class="markdown-body"><h1>예시 논문 제목</h1><p>이것은 샘플 논문 내용입니다...</p></div>';
            document.getElementById('summary-tab').innerHTML = '<div class="markdown-body"><h2>요약</h2><p>이 논문은 다음과 같은 내용을 다루고 있습니다...</p></div>';
            document.getElementById('references-tab').innerHTML = '<div class="markdown-body"><h2>참조</h2><ul><li>참조 문헌 1</li><li>참조 문헌 2</li></ul></div>';
            
            // 저장 버튼 표시
            document.getElementById('save-button-container').classList.remove('hidden');
            
            // 저장 버튼 클릭 이벤트
            document.getElementById('save-button').addEventListener('click', function() {
                savePaperAnalysis(paperId);
            });
        }
        
        // 논문 분석 결과 저장
        function savePaperAnalysis(paperId) {
            // 실제로는 탭에 표시된 결과를 가져와서 저장
            const originalContent = document.querySelector('.markdown-body').innerHTML;
            const translation = document.querySelector('#translation-tab .markdown-body').innerHTML;
            const summary = document.querySelector('#summary-tab .markdown-body').innerHTML;
            const references = document.querySelector('#references-tab .markdown-body').innerHTML;
            
            const formData = new FormData();
            formData.append('original_content', originalContent);
            formData.append('translation', translation);
            formData.append('summary', summary);
            formData.append('references', references);
            
            fetch(`/paper/save/${paperId}`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('논문 분석 결과가 저장되었습니다.');
                    // 마이페이지로 리다이렉트 또는 다른 처리
                    window.location.href = '/mypage';
                } else {
                    alert('저장에 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('저장 중 오류가 발생했습니다.');
            });
        }
    });
</script>
{% endblock %}